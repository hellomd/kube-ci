apiVersion: v1
kind: Service
metadata:
  name: $CIRCLE_PROJECT_REPONAME
  namespace: default
  labels:
    app: $CIRCLE_PROJECT_REPONAME
spec:
  type: NodePort
  ports:
  - port: 80
    targetPort: 3000
  selector:
    app: $CIRCLE_PROJECT_REPONAME
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: $CIRCLE_PROJECT_REPONAME
  namespace: default
  labels:
    app: $CIRCLE_PROJECT_REPONAME
spec:
  replicas: 1
  selector:
    matchLabels:
      app: $CIRCLE_PROJECT_REPONAME
  template:
    metadata:
      labels:
        app: $CIRCLE_PROJECT_REPONAME
    spec:
      containers:
      - name: $CIRCLE_PROJECT_REPONAME
        image: us.gcr.io/hellomd-181719/$CIRCLE_PROJECT_REPONAME:$CIRCLE_BRANCH
        ports:
        - containerPort: 80
        livenessProbe:
          httpGet:
            path: /healthcheck
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 30
        env:
        - name: AMQP_URL
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: amqpUrl
        - name: ENV
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: env
        - name: GATEWAY_URL
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: gatewayUrl
        - name: LOGMATIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: logmaticApiKey
        - name: MONGO_URL
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: mongoUrl
        - name: SECRET
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: secret
        - name: SENTRY_DSN
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: sentryDsn
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: awsKey
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: awsSecret
        - name: AWS_DEFAULT_REGION
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: awsRegion
        - name: ELASTIC_URL
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: elasticUrl
        - name: ELASTIC_USER
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: elasticUser
        - name: ELASTIC_PASS
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: elasticPass
        - name: MYSQL_CONN_STRING
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: mysqlConnString
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: cloudsql-db-credentials
              key: username
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: cloudsql-db-credentials
              key: password
        - name: SENDGRID_API_KEY
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: sendgridApiKey
        - name: SITE_URL
          valueFrom:
            secretKeyRef:
              name: shared-env
              key: siteUrl
